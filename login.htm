<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Blue Iris Login</title>
	<script type="text/javascript">
		var login_version = "8";
		var bi_version = "%%VERSION%%";
	</script>
	<script type="text/javascript">
		window.onerror = function (msg, url, line, charIdx)
		{
			try
			{
				var versionStr = "unknown";
				if (typeof login_version != "undefined")
					versionStr = login_version;
				var biVersionStr = "unknown";
				if (typeof bi_version != "undefined")
					biVersionStr = bi_version;
				url = url.replace(/\/\/.*?\//, '//censored_hostname/');
				alert("An unexpected error has occurred in Blue Iris Login (version " + versionStr + " / " + biVersionStr + ").\n\nIf you wish to report the error, please SCREENSHOT the browser now.\n\n" + msg + "\nURL: " + url + "\nLine: " + line + "\nChar: " + charIdx);
			}
			catch (ex)
			{
				alert(ex);
			}
		};
	</script>
	<style type="text/css">
		body
		{
			font-family: sans-serif;
			background: #212325;
		}

		#loginLoading
		{
			text-shadow: 0 0 10px rgba(0,0,0,0.3);
			position: absolute;
			text-align: center;
			top: 40%;
			width: 100%;
			color: #FFFFFF;
		}

			#loginLoading h1
			{
				margin: 0 0 20px 0;
				font-size: 32px;
			}

			#loginLoading div
			{
				font-size: 20px;
			}

		#login
		{
			display: none;
		}
	</style>
	<script src="applet/loginScripts.js?v=8_%%VERSION%%" type="text/javascript"></script>
	<link href="applet/loginStyles.css?v=8_%%VERSION%%" rel="stylesheet" type="text/css">
	<script type="text/javascript">
		var autologin_timeout_1 = null;
		var autologin_timeout_2 = null;
		var existingSession = "";
		var isStoredDataLoaded = false;
		var windowUnloading = false;
		$(function ()
		{
			$("#loginLoading").hide();
			$("#login").show();
			if (typeof window.JSON == 'undefined')
			{
				$("#login").text("Your web browser is too old to use the Blue Iris web interface properly.\n\nTo proceed with this browser, disable the \"Secure only\" requirement within Blue Iris's web server settings.");
				$("#login").css("color", "#EEEEEE").css("margin", "8px");
				return;
			}
			if (UrlParameters.Get("autologin") == "0")
			{
				SetPersistedValue("bi_override_disable_auto_login_once", "1");
				location.href = location.href.replace(/autologin=0&?/gi, '');
				return;
			}
			$(window).resize(resized);
			resized();
			window.onbeforeunload = function ()
			{
				windowUnloading = true;
				cbLoginAutomaticallyClicked();
				return;
			}
			var skipAutoLogin = GetPersistedValue("bi_override_disable_auto_login_once") == "1";
			if (skipAutoLogin)
			{
				SetPersistedValue("bi_override_disable_auto_login_once", "0");
			}
			// Handle automatic login
			if (GetPersistedValue("bi_rememberMe") == "1")
			{
				$("#cbLoginAutomatically").attr('checked', 'checked');
				$("#txtUn").val(Base64.decode(GetPersistedValue("bi_username")));
				$("#txtPw").val(Base64.decode(GetPersistedValue("bi_password")));

				if (!skipAutoLogin)
				{
					if ($("#txtUn").val() != "" && $("#txtPw").val() != "")
					{
						if ($("#txtUn").val() == "SOME_USER_NAME_TO_LOG_IN_INSTANTLY")
						{
							if ($("#cbLoginAutomatically").is(":checked"))
								login();
						}
						else
						{
							$("#btnLogin").val("Logging in, in 2 seconds");
							autologin_timeout_1 = setTimeout(function () { $("#btnLogin").val("Logging in, in 1 second"); }, 1000);
							autologin_timeout_2 = setTimeout(function ()
							{
								if ($("#cbLoginAutomatically").is(":checked"))
									login();
							}, 2000);
						}
					}
				}
			}
			else
			{
				$("#cbLoginAutomatically").removeAttr('checked');
				SetPersistedValue("bi_username", "");
				SetPersistedValue("bi_password", "");
			}

			// Check for existing session
			ExecJSON({ cmd: "login", session: $.cookie("session") }, function (response)
			{
				if (response.result == "fail")
				{
					// No existing session. Attempt Anonymous login
					var myResponse = md5("Anonymous:" + response.session + ":");
					ExecJSON({ cmd: "login", session: response.session, response: myResponse }, function (response)
					{
						if (response.result == "success")
						{
							existingSession = response.session;
							SetStatus("An anonymous " + (response.data.admin ? "administrator" : "user") + ' session is available. <a href="javascript:LeaveLoginPage()">Click here to use it.</a>');
						}
					},
						function (jqXHR, textStatus, errorThrown)
						{
							HandleError("Unable to contact Blue Iris server");
						});
				}
				else if (response.result == "success")
				{
					existingSession = response.session;
					SetStatus("An existing " + (response.data.admin ? "administrator" : "user") + ' session is available. <a href="javascript:LeaveLoginPage()">Click here to use it.</a>');
				}
			},
				function (jqXHR, textStatus, errorThrown)
				{
					HandleError("Unable to contact Blue Iris server");
				});

			// Set focus on first empty field
			if (!$("#txtUn").val())
				$("#txtUn").get(0).focus();
			else if (!$("#txtPw").val())
				$("#txtPw").get(0).focus();
			else
				$("#btnLogin").get(0).focus();

			isStoredDataLoaded = true;
		});
		function login()
		{
			cbLoginAutomaticallyClicked();
			$("#btnLogin").val("Logging in ...");
			SetStatus();
			ExecJSON({ cmd: "login" }, function (response)
			{
				var myResponse = md5($("#txtUn").val() + ":" + response.session + ":" + $("#txtPw").val());
				ExecJSON({ cmd: "login", session: response.session, response: myResponse }, function (response)
				{
					if (response.result == "success")
					{
						$("#btnLogin").attr("disabled", "disabled").val("Redirecting...");
						existingSession = response.session;
						LeaveLoginPage();
					}
					else
					{
						$("#btnLogin").val("Log in");
						HandleError(response.data ? response.data.reason : "Login failed but Blue Iris did not provide a reason.");
					}
				},
					function (jqXHR, textStatus, errorThrown)
					{
						HandleError("Unable to contact Blue Iris server");
						$("#btnLogin").val("Log in");
					});
			},
				function (jqXHR, textStatus, errorThrown)
				{
					HandleError("Unable to contact Blue Iris server");
					$("#btnLogin").val("Log in");
				});
		}
		function LeaveLoginPage()
		{
			$.cookie("session", existingSession, { path: "/" });
			var page = UrlParameters.Get("page");
			if (page == "")
				page = "/";
			location.href = page + location.hash;
		}
		function cancelAutoLogin()
		{
			if (autologin_timeout_1 != null)
			{
				clearTimeout(autologin_timeout_1);
				autologin_timeout_1 = null;
			}
			if (autologin_timeout_2 != null)
			{
				clearTimeout(autologin_timeout_2);
				autologin_timeout_2 = null;
			}
			$("#btnLogin").val(windowUnloading ? "Redirecting..." : "Log in");
		}
		function cbLoginAutomaticallyClicked()
		{
			cancelAutoLogin();
			if (!isStoredDataLoaded)
				return;
			var isChecked = $("#cbLoginAutomatically").is(":checked");
			SetPersistedValue("bi_rememberMe", isChecked ? "1" : "0");
			SetPersistedValue("bi_username", isChecked ? Base64.encode($("#txtUn").val()) : "");
			SetPersistedValue("bi_password", isChecked ? Base64.encode($("#txtPw").val()) : "");
		}
		function GetPersistedValue(key)
		{
			var value;
			if (typeof Storage !== "undefined" && localStorage)
				value = localStorage.getItem(key);
			else
				value = $.cookie(key);
			if (!value)
				value = "";
			return value;
		}
		function SetPersistedValue(key, value)
		{
			if (typeof Storage !== "undefined" && localStorage)
				return localStorage.setItem(key, value);
			else
				return $.cookie(key, value, { expires: 365 });
		}
		function pwKeypress(ele, e)
		{
			var keycode;
			if (window.event) keycode = window.event.keyCode;
			else if (typeof e != "undefined" && e) keycode = e.which;
			else return true;

			if (keycode == 13)
			{
				login();
				return false;
			}
			else
				return true;
		}
		function resized()
		{
			$("#status").hide();
			$("#status").css("max-width", $("#login").width() + "px");
			$("#status").show();
			$('#login').css({ position: 'absolute', left: ($(window).width() - $('#login').outerWidth()) / 2, top: ($(window).height() - $('#login').outerHeight()) / 2 });
			$("#status").css("max-width", $("#login").width() + "px");
			var heightTotal = 0;
			$("#login").children().each(function (idx, ele)
			{
				heightTotal += $(ele).outerHeight(true);
			});
			if (heightTotal > $(window).height())
			{
				if ($("#status").parent().attr("id") != "status_wrapper_upper")
					$("#status_wrapper_upper").append($("#status"));
			}
			else
			{
				if ($("#status").parent().attr("id") != "status_wrapper_lower")
					$("#status_wrapper_lower").append($("#status"));
			}
			$("#lblLoginAutomatically").parent().css("margin-left", (($('#login').outerWidth() - $("#lblLoginAutomatically").outerWidth(true)) / 2) + "px");
		};
		function HandleError(error)
		{
			SetStatus(error, "#FF6262");
		}
		function SetStatus(html, color)
		{
			if (typeof html == "undefined" || html == null || html == "")
			{
				html = "";
				$("#status").hide();
			}
			else
				$("#status").show();
			if (typeof color == "undefined" || color == null || color == "")
				color = "#FFFFFF";
			$("#status").html(html);
			$("#status").css("color", color);
			resized();
		}
	</script>
</head>
<body>
	<div id="loginLoading">
		<h1>%%SYSNAME%%</h1>
		<div>Loading login page...</div>
	</div>
	<div id="login">
		<h1>%%SYSNAME%%</h1>
		<input id="txtUn" type="text" class="text" placeholder="Username" autocapitalize="off" autocorrect="off" />
		<input id="txtPw" type="password" class="text" placeholder="Password" onkeypress="return pwKeypress(this,event)" autocapitalize="off" autocorrect="off" />
		<div class="checkboxWrapper">
			<input id="cbLoginAutomatically" type="checkbox" class="checkbox" onchange="cbLoginAutomaticallyClicked()" /><label for="cbLoginAutomatically" id="lblLoginAutomatically"><span class="ui"></span>Log in automatically:</label>
		</div>
		<div id="status_wrapper_upper"></div>
		<input id="btnLogin" type="button" class="btn" value="Log in" onclick="login()" />
		<div id="status_wrapper_lower"><div id="status"></div></div>
	</div>
</body>
</html>
